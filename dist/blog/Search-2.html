<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pedro Blog | 自制信息检索网站（三）——Go 语言标准库实现后端</title>
    <meta name="description" content="Just a blog for a unknown man">
    
    
    <link rel="preload" href="/assets/css/0.styles.2124b703.css" as="style"><link rel="preload" href="/assets/js/app.2c76701a.js" as="script"><link rel="preload" href="/assets/js/9.9e9978a4.js" as="script"><link rel="prefetch" href="/assets/js/7.69c868d8.js"><link rel="prefetch" href="/assets/js/1.5f21b350.js"><link rel="prefetch" href="/assets/js/2.ad147154.js"><link rel="prefetch" href="/assets/js/3.dec539e8.js"><link rel="prefetch" href="/assets/js/4.379f4350.js"><link rel="prefetch" href="/assets/js/5.39f5f0d6.js"><link rel="prefetch" href="/assets/js/6.1e5d73bd.js"><link rel="prefetch" href="/assets/js/8.4936efcb.js"><link rel="prefetch" href="/assets/js/10.f3f4ca22.js"><link rel="prefetch" href="/assets/js/11.58ce6f32.js"><link rel="prefetch" href="/assets/js/12.6c7981c3.js"><link rel="prefetch" href="/assets/js/13.593672d8.js"><link rel="prefetch" href="/assets/js/14.e1db0581.js"><link rel="prefetch" href="/assets/js/15.4bc5cf62.js"><link rel="prefetch" href="/assets/js/16.de4f6602.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2124b703.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Pedro Blog
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/essay/" class="nav-link">随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><a href="https://coding.net/u/pedrogao/p/cookbook-doc/git?public=true" target="_blank" rel="noopener noreferrer" class="repo-link">
    Source
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/essay/" class="nav-link">随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><a href="https://coding.net/u/pedrogao/p/cookbook-doc/git?public=true" target="_blank" rel="noopener noreferrer" class="repo-link">
    Source
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>博客</span><!----></p><ul class="sidebar-group-items"><li><a href="/blog/" class="sidebar-link">谈谈瓶颈</a></li><li><a href="/blog/Go-1.html" class="sidebar-link">Go 语言，Vue，Elasticsearch 打造个人博客</a></li><li><a href="/blog/Go-2.html" class="sidebar-link">Go 语言学习（1）——标准库 fmt</a></li><li><a href="/blog/Search-1.html" class="sidebar-link">自制信息检索网站（一）——爬取掘金数据</a></li><li><a href="/blog/Search-2.html" class="active sidebar-link">自制信息检索网站（三）——Go 语言标准库实现后端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/Search-2.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/Search-2.html#utils" class="sidebar-link">utils</a></li><li class="sidebar-sub-header"><a href="/blog/Search-2.html#log" class="sidebar-link">log</a></li><li class="sidebar-sub-header"><a href="/blog/Search-2.html#elastic" class="sidebar-link">elastic</a></li><li class="sidebar-sub-header"><a href="/blog/Search-2.html#router" class="sidebar-link">router</a></li><li class="sidebar-sub-header"><a href="/blog/Search-2.html#main" class="sidebar-link">main</a></li></ul></li><li><a href="/blog/Search-3.html" class="sidebar-link">自制信息检索网站（二）——分析掘金数据</a></li><li><a href="/blog/Spring-1.html" class="sidebar-link">SpringBoot 学习（一）起手式与 RestController</a></li><li><a href="/blog/Spring-2.html" class="sidebar-link">SpringBoot 学习（三）Spring-data-jpa</a></li><li><a href="/blog/Spring-3.html" class="sidebar-link">SpringBoot 学习（二）——过滤器 filter,拦截器 intercepter,切面 aspect</a></li><li><a href="/blog/Web-1.html" class="sidebar-link">Web 学习（1）——标准库 http 实现 server</a></li><li><a href="/blog/Web-2.html" class="sidebar-link">Web 学习（2）——实现中间件(middleware)</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="自制信息检索网站（三）——go-语言标准库实现后端"><a href="#自制信息检索网站（三）——go-语言标准库实现后端" aria-hidden="true" class="header-anchor">#</a> 自制信息检索网站（三）——Go 语言标准库实现后端</h1><h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2><p>前两篇博客介绍到了掘金数据的爬取和分析，而我们的最终目的是搭建一个小型的检索系统。当然数据全都是偷掘金的了（笑）。目前这个项目已经搭建完毕了，已经发布到 github 上面了<a href="https://github.com/PedroGao/juejin_spider" target="_blank" rel="noopener noreferrer">juejin</a>，另外我也之前做了一个伯乐在线的小型检索系统，地址在这<a href="https://github.com/PedroGao/elasticsearch-demo" target="_blank" rel="noopener noreferrer">demo</a>。</p><p>下面就进入今天的正题，关于如何使用 Go 语言搭建一个简单的后台项目。由于在信息搜索上面使用到了 ElasticSearch 这个非常棒的开源项目，所以也使用了 Go 语言版的 elastic 实现了内容搜索，这也是这个后台项目唯一的第三方依赖，其它都为 Go 语言标准库实现的。项目结构入如下图所示：
<img src="https://user-gold-cdn.xitu.io/2018/1/30/16146d4576177ef1?w=150&h=337&f=jpeg&s=15454" alt>在 static 文件夹下是前端的资源部分，view 文件夹下是前端视图部分，juejin 文件夹下是后台项目的依赖，main.go 文件是整个项目的入口，接下来让我们由浅入深的看一下整个项目。</p><h2 id="utils"><a href="#utils" aria-hidden="true" class="header-anchor">#</a> utils</h2><p>因为这个项目的场景不大单纯的只是涉及了内容检索以及资源服务，所以 utils 这里面的东西并没有太多，而由于 Go 语言的特性，它会经常涉及 error 的检查，所以整个 utils.go 里面也就只有关于 error 的处理的两个方法。</p><pre class="language-go"><code><span class="token comment">// print the error</span>
<span class="token keyword">func</span> <span class="token function">ErrorPrint</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><p>第一个方法，由于在使用 elastic 查询内容时不可避免的会出现 error，可是又不能让程序 crash 掉，于是便有了这个 ErrorPrint 方法。</p><pre class="language-go"><code><span class="token comment">// fatal the error then the program will be broken</span>
<span class="token keyword">func</span> <span class="token function">ErrorFatal</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>第二个方法，是用于程序出现了严重错误，没有必要在继续运行下去所定义的方法，对于严重的 error 如在 http 在 ListenAndServe 时出错，便可以直接 Fatal。</p><h2 id="log"><a href="#log" aria-hidden="true" class="header-anchor">#</a> log</h2><p>顾名思义，这个 log.go 里面实现了日志打印的功能，对于检测程序运行情况，以及查看请求的信息，一个简单的日志打印功能是十分有必要的。</p><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">WriteLog</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> t time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> match <span class="token builtin">string</span><span class="token punctuation">,</span> pattern <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	d <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>

	l <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;[ACCESS] | % -10s | % -40s | % -16s | % -10s | % -40s |&quot;</span><span class="token punctuation">,</span> <span class="token function">Bold</span><span class="token punctuation">(</span><span class="token function">Blue</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Red</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Green</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>这个函数会对请求的路径和方法，以及响应时间，匹配路径进行日志输出。至于里面的 Red(),Green(),Bold()均是为了改变在终端里面的字体颜色，让整个日志信息更为清晰。效果图如下：</p><p><img src="https://user-gold-cdn.xitu.io/2018/1/30/16146e5f0d384ef5?w=1277&h=366&f=jpeg&s=78243" alt></p><h2 id="elastic"><a href="#elastic" aria-hidden="true" class="header-anchor">#</a> elastic</h2><p>前面也说到，整个项目会不断的涉及文章检索，内容推荐的操作，而这些便都需要使用 elasticsearch 来完成，因此笔者把所有关于与 elasticsearch 交互的功能写在了这个文件里面，其实它也很简单，只是接收请求的参数并将其结构化用来请求 elasticsearch。首先看这个 getItems 函数。</p><pre class="language-go"><code><span class="token comment">// get the article items from the elastic server</span>
<span class="token keyword">func</span> <span class="token function">getItems</span><span class="token punctuation">(</span>keyword <span class="token builtin">string</span><span class="token punctuation">,</span> page <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>elastic<span class="token punctuation">.</span>SearchHits <span class="token punctuation">{</span>
	<span class="token comment">// search result from the tags,title,content of the article item</span>
	query <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMultiMatchQuery</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> <span class="token string">&quot;tags&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span>
	result<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">Index</span><span class="token punctuation">(</span><span class="token string">&quot;juejin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">Query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">Do</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token operator">:=</span> <span class="token function">ErrorPrint</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> result<span class="token punctuation">.</span>Hits
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><p>这个函数接收两个参数 keyword 和 page,即关键词和页数。然后将它们写入 elasticsearch 的复合查询中，并将 hits 结果返回。实际的结果如下图：</p><p><img src="https://user-gold-cdn.xitu.io/2018/1/30/16146ef50ecaa0a6?w=1848&h=973&f=png&s=251024" alt>
另外还有一个 getSuggestions 函数主要用来做搜索框的提示功能，具体实现大同小异，这里边不同阐述。</p><h2 id="router"><a href="#router" aria-hidden="true" class="header-anchor">#</a> router</h2><p>在 router.go 里面首先定义了一个结构体：</p><pre class="language-go"><code><span class="token keyword">type</span> Controller <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	HandleFunction <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span>
	Method         <span class="token builtin">string</span>
	Pattern        <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><p>这个结构体里面有三个成员，HandleFunction 用来处理请求的响应函数，Method 用来装填请求方法，Pattern 用来匹配请求的路径，这里使用了正则匹配。</p><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">GetItems</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">ParseForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	keyword <span class="token operator">:=</span> r<span class="token punctuation">.</span>Form<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">)</span>
	page_str <span class="token operator">:=</span> r<span class="token punctuation">.</span>Form<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> page_str <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token comment">// w.WriteHeader(403)</span>
		page_str <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span>
	<span class="token punctuation">}</span>
	page<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>page_str<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token operator">:=</span> <span class="token function">ErrorPrint</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span>
		items <span class="token operator">:=</span> <span class="token function">getItems</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> page<span class="token punctuation">)</span>
		<span class="token keyword">if</span> items <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
			ok <span class="token operator">=</span> <span class="token function">ErrorPrint</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
				w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>上面的代码是 router.go 里面的一个方法，主要用来响应网页对于文章内容的请求，效果图便是上面的效果图了。这个函数首先会调用 ParseForm 方法解析请求的参数，由于 elastic 的在 page 上不能使用空值，因此如果接受到的 page 参数为空的话会将其处理成 1，然后在 Header 里将返回的数据类型设置为 json，并且调用 elastic.go 里面的 getItems 函数，通过 json 的编组函数 Marshal 得到 json 格式的数据并返回。router.go 里面的其它方法也是如此实现的。</p><h2 id="main"><a href="#main" aria-hidden="true" class="header-anchor">#</a> main</h2><p>由于本次使用的是 Go 语言 http.Server 这个结构体实现的服务器，因此就必须自定义一个自己的 HttpHandler 并实现 ServeHTTP 这个方法。</p><pre class="language-go"><code><span class="token keyword">type</span> httpHandler <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>httpHandler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> controller <span class="token operator">:=</span> <span class="token keyword">range</span> mux <span class="token punctuation">{</span>
		<span class="token keyword">if</span> ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span>Pattern<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">==</span> controller<span class="token punctuation">.</span>Method <span class="token punctuation">{</span>
				controller<span class="token punctuation">.</span><span class="token function">HandleFunction</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
				<span class="token keyword">go</span> juejin<span class="token punctuation">.</span><span class="token function">WriteLog</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token string">&quot;matched&quot;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>Pattern<span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> juejin<span class="token punctuation">.</span><span class="token function">WriteLog</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token string">&quot;unmatch&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><p>这个结构体会传到 Server.Handler 这个参数上，它来实现整个的路由调配。首先它会得到当前的时间 t,然后遍历 mux 这个切片。</p><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mux <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mux<span class="token punctuation">,</span> juejin<span class="token punctuation">.</span>Controller<span class="token punctuation">{</span>juejin<span class="token punctuation">.</span>GetItems<span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;^/api/getItems&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	mux <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mux<span class="token punctuation">,</span> juejin<span class="token punctuation">.</span>Controller<span class="token punctuation">{</span>juejin<span class="token punctuation">.</span>GetSuggestions<span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;^/api/getSuggestions&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	mux <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mux<span class="token punctuation">,</span> juejin<span class="token punctuation">.</span>Controller<span class="token punctuation">{</span>Static<span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;^/static/&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	mux <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>mux<span class="token punctuation">,</span> juejin<span class="token punctuation">.</span>Controller<span class="token punctuation">{</span>DefaultPage<span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;^/&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>mux 这个切片里面存放着所有处理请求的方法。当用户请求的方法通过正则匹配到了我们的路径时便调用这个 controller 里面的方法即 controller.HandleFunction(w, r)，然后打印一条日志，如果不匹配，则打印不匹配的日志。</p><p>另外 mux 里面前两个都是数据请求的处理，Static 这个方法用于处理静态文件，具体如下：</p><pre class="language-go"><code><span class="token keyword">var</span> wd<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Static</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	path <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>wd<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">ServeFile</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> path<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>我们通过 os.Getwd 获得当前工作路径，然后通过请求的资源路径并且将这个静态资源通过 http.ServeFile 方法返回给用户这个资源。</p><p>DefaultPage 这个方法用于服务于默认的请求页面。</p><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DefaultPage</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tmpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">ParseFiles</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>wd<span class="token punctuation">,</span> <span class="token string">&quot;view/index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> tmpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>这个方法通过 html/template 这个默认引擎来处理我们的 index.html 页面，当用户请求时便处理这个模板，然后写入到 ResponseWriter 中。另外由于我们使用的是正则匹配，并且通过 for 循环来遍历匹配请求路径，因此必须将&quot;^/&quot;这个路径放在切片的最末尾，否则其它所有请求都会被它匹配，而一旦被它匹配到便会调用 DefaltPage 这个 Controller，其它的 Controller 便不会调用，整个项目也无法正常运行。好了，由于最近一直在学习 Go 语言，所以做了项目练手，但确实对路由架构这方面不熟悉，所以整个路由结构非常凌乱。如果您有什么建议，请不吝赐教。</p></div><div class="content edit-link"><a href="https://coding.net/u/pedrogao/p/cookbook-doc/git?public=true/edit/master/docs/blog/Search-2.md" target="_blank" rel="noopener noreferrer">Edit this page</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/blog/Search-1.html" class="prev">
          自制信息检索网站（一）——爬取掘金数据
        </a></span><span class="next"><a href="/blog/Search-3.html">
          自制信息检索网站（二）——分析掘金数据
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/9.9e9978a4.js" defer></script><script src="/assets/js/app.2c76701a.js" defer></script>
  </body>
</html>
